name: Prepare Apple Environment
description: Prepares the environment to be used for distributing apps on Apple's platforms.
author: Simon B. StÃ¸vring
on:
  workflow_call:
    inputs:
      config-path:
        required: true
        type: string
    secrets:
      CI_SSH_KEY:
        required: true
      CI_SSH_KNOWN_HOSTS:
        required: true
      SHIPSHAPE_ACTIVATION_CODE:
        required: true
      APPLE_ENTERPRISE_DISTRIBUTION_CERTIFICATE:
        required: true
      APPLE_ENTERPRISE_DISTRIBUTION_CERTIFICATE_PASSWORD:
        required: true
jobs:
  ship:
    runs-on: macos-12
    steps:
      - name: Install SSH Key
        uses: benoitchantre/setup-ssh-authentication-action@1.0.0
        with:
          private-key: ${{ secrets.CI_SSH_KEY }}
          known-hosts: ${{ secrets.CI_SSH_KNOWN_HOSTS }}
      - name: Install Shipshape
        run: npm install -g git+ssh://git@github.com:shapehq/ship-shape-cli.git
        shell: bash
      - name: Setup Shipshape Activation Code
        run: echo '{"ship_activation_code":"${{ secrets.SHIPSHAPE_ACTIVATION_CODE }}"}' > ~/shape-dev.config
        shell: bash
      - name: Install appiconannotator
        run: npm install -g git+ssh://git@github.com:shapehq/appiconannotator
        shell: bash
      - name: Set Up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.2
          bundler-cache: true
      - name: Install Certificate
        uses: apple-actions/import-codesign-certs@v1
        with: 
          p12-file-base64: ${{ secrets.APPLE_ENTERPRISE_DISTRIBUTION_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_ENTERPRISE_DISTRIBUTION_CERTIFICATE_PASSWORD }}
